PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX b3: <https://dcm.ffclrp.usp.br/lssb/stock-market-ontology#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#> # Pode remover se não for usar explicitamente tipos xsd nos filtros

SELECT DISTINCT ?ticker # Apenas ?ticker aqui, o BIND define ele
WHERE {
  ?empresa rdfs:label #ENTIDADE_NOME#@pt . # Assumindo @pt nos labels

  OPTIONAL {
    ?empresa b3:temValorMobiliarioNegociado ?vmIntermediario . 
    ?vmIntermediario b3:representadoPor ?codigoInst1 .
    ?codigoInst1 b3:ticker ?tickerPath1 .
    FILTER(REGEX(STR(?tickerPath1), "^[A-Z]{4}[0-9]{1,2}$", "i"))
  }

  OPTIONAL {
    ?empresa b3:temValorMobiliarioNegociado ?codigoInstVM . 
    ?codigoInstVM b3:ticker ?tickerPath2 . # Se o VM já tem o ticker
    FILTER(REGEX(STR(?tickerPath2), "^[A-Z]{4}[0-9]{1,2}$", "i"))
  }

  OPTIONAL {
    ?empresa b3:representadoPor ?codigoInstDireto .
    ?codigoInstDireto b3:ticker ?tickerPath3 .
    FILTER(REGEX(STR(?tickerPath3), "^[A-Z]{4}[0-9]{1,2}$", "i"))
  }
  
  BIND(COALESCE(?tickerPath1, ?tickerPath2, ?tickerPath3) AS ?ticker)
  FILTER(BOUND(?ticker))
}
ORDER BY ?ticker
LIMIT 20